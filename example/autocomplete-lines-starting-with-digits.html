<!DOCTYPE html>
<html>
<head>
	<title>EditDidWhat &lt;textarea /&gt; input with basic inline autocomplete for even
		lines starting with digits</title>
</head>
<body>
	<h1>
		<a href="https://github.com/joelpurra/editdidwhat">EditDidWhat</a> &lt;textarea
		/&gt; input with basic inline autocomplete</h1>
	<p>
		A listener will wait for user input in the textarea. Enter anything on odd lines,
		try starting even lines with digits.
	</p>	
	<fieldset>
		<legend>Input with basic inline autocomplete</legend>
		<textarea id="address" cols="50" rows="10"></textarea>
	</fieldset>
	<script src="../src/editdidwhat.joelpurra.js"></script>
	<script src="http://code.jquery.com/jquery-latest.js"></script>
	<script src="http://jcaret.googlecode.com/files/jquery.caret.1.02.js"></script>
	<script>
		var 
			startsWithDigits = /^(\d+)/,
			names = "Alfred Baltsar Camilla Diana Erland Frideborg Gunnar Hanna Ivar Jan".split(/\s+/);

		// Multiple digits will be autocompleted to multiple names
		function getNamesFromDigits(digits)
		{
			var 
				i,
				digit,
				output = [];

			for (i = 0; i < digits.length; i += 1)
			{
				digit = parseInt(digits.charAt(i));
				output.push(names[digit]);
			}

			return output.join(", ");
		}

		// Listen on keyup to get the new value in the textarea
		$("#address")
			.on("keyup change", function (event)
			{
				autocompleteDigits($(this));
			});

		// Check for digits on every other line, and autocomplete the line with names
		function autocompleteDigits($textarea)
		{
			var 
				previous,
				current,
				change,
				diffIndex,
				lastDiffIndex,
				diffLineNumber,
				lastDiffLineNumber,
				diffLine,
				diffLineStart,
				diffLineEnd,
				digits,
				autocompleteWith,
				autocompleted;

			// Previous value is stored on the <textarea /> element
			previous = $textarea.data().previousValue || "";
			current = $textarea.val();

			$textarea.data({
				previousValue: current
			});

			// Don't act on all sorts of changes
			change = EditDidWhat.detectChange(previous, current);

			if (!(change == EditDidWhat.StatusAdd
				|| change == EditDidWhat.StatusReplace
				|| change == EditDidWhat.StatusAppended))
			{
				return;
			}

			// Use EditDidWhat do find where the changes were made
			diffIndex = EditDidWhat.findDifferenceIndex(previous, current);
			lastDiffIndex = EditDidWhat.findLastDifferenceIndex(previous, current);
			diffLineNumber = EditDidWhat.getLineNumberAt(current, diffIndex);
			lastDiffLineNumber = EditDidWhat.getLineNumberAt(current, lastDiffIndex);

			// Don't act if
			//	the change is on an odd (even in 0-indexed)
			//	or affects several lines
			//	or was a linebreak
			if ((diffLineNumber % 2) === 0
				|| diffLineNumber !== lastDiffLineNumber
				|| current.charAt(lastDiffIndex) === '\n')
			{
				return;
			}

			// The full contents of the line that had changes
			diffLine = EditDidWhat.getLine(current, diffLineNumber);

			// Only do autocomplete if the line starts with digits
			if (startsWithDigits.test(diffLine))
			{
				startsWithDigits.exec(diffLine);

				digits = RegExp.$1;

				// Get data based on the input on the line
				// Digits could be zipcodes, product codes or something in another format,
				// like mail addresses, usernames, filenames
				autocompleteWith = getNamesFromDigits(digits);

				// This is the autocomplete; add names after the digits
				autocompleted = EditDidWhat.replaceLine(current, diffLineNumber, digits + " " + autocompleteWith);

				// Get line bounds to select the text below
				diffLineStart = EditDidWhat.getLineStart(autocompleted, diffLineNumber);
				diffLineEnd = EditDidWhat.getLineEnd(autocompleted, diffLineNumber);

				// Update the textarea
				$textarea.val(autocompleted);

				// Select the autocompleted text to let the user continue typing digits
				$textarea.caret(diffLineStart + digits.length, diffLineEnd + 1);

				// Depending on the changes made, optionally alert other listeners
				//$textarea.change();
			}
		}
	</script>
</body>
</html>
